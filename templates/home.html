{% extends 'base.html' %}
{% load number_extras %}
{% block title %}Bảng điều khiển - NavyBaby{% endblock %}
{% block navbar_icon %}gauge{% endblock %}
{% block navbar_title %}Tổng quan{% endblock %}
{% block content %}

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-6">
  <div>
    <h2 class="text-2xl font-bold flex items-center text-blue-400">
      <i data-lucide="pie-chart" class="w-6 h-6 mr-2"></i>Bảng điều khiển
    </h2>
    <p class="text-gray-400">Tổng quan về hoạt động kinh doanh</p>
  </div>
  <span class="bg-blue-900/30 text-blue-300 px-3 py-1 rounded-md text-sm font-medium border border-blue-800">NavyBaby v1.0.1</span>
</div>

<!-- Thống kê tổng quan -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <a href="{% url 'customers:customer_list' %}" class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700 block">
    <i data-lucide="users" class="w-8 h-8 text-blue-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ total_customers }}</h4>
    <p class="text-gray-400 text-sm">Khách hàng</p>
  </a>

  <a href="{% url 'products:product_list' %}" class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700 block">
    <i data-lucide="warehouse" class="w-8 h-8 text-green-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ total_products }}</h4>
    <p class="text-gray-400 text-sm">Sản phẩm</p>
  </a>

  <a href="{% url 'orders:order_list' %}" class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700 block">
    <i data-lucide="shopping-cart" class="w-8 h-8 text-yellow-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ total_orders }}</h4>
    <p class="text-gray-400 text-sm">Đơn hàng</p>
  </a>

  <div class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700">
    <i data-lucide="coins" class="w-8 h-8 text-purple-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ net_profit|default:0|smart_vnd }}</h4>
    <p class="text-gray-400 text-sm">Lãi ròng ước tính</p>
  </div>
</div>

<!-- Biểu đồ doanh thu & đơn hàng 30 ngày -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <div class="flex items-center justify-between mb-3">
      <h5 class="font-semibold text-lg flex items-center text-emerald-400">
        <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>Doanh thu 30 ngày qua
      </h5>
      <div class="text-right">
        <p class="text-xs text-gray-400">Tổng</p>
        <p id="totalRevenue" class="text-lg font-bold text-emerald-400">-</p>
      </div>
    </div>
    <div class="h-64">
      <canvas id="revenueChart"></canvas>
    </div>
  </div>
  
  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <div class="flex items-center justify-between mb-3">
      <h5 class="font-semibold text-lg flex items-center text-yellow-400">
        <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>Số lượng đơn hàng 30 ngày qua
      </h5>
      <div class="text-right">
        <p class="text-xs text-gray-400">Tổng</p>
        <p id="totalOrders" class="text-lg font-bold text-yellow-400">-</p>
      </div>
    </div>
    <div class="h-64">
      <canvas id="orderCountChart"></canvas>
    </div>
  </div>
</div>

<!-- Top sản phẩm, Top khách hàng & Phân bố trạng thái -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
  <!-- Top sản phẩm -->
  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <h5 class="font-semibold text-lg mb-3 flex items-center text-blue-400">
      <i data-lucide="package" class="w-5 h-5 mr-2"></i>Top sản phẩm tháng này
    </h5>
    <div class="h-80">
      <canvas id="topProductsChart"></canvas>
    </div>
  </div>

  <!-- Top khách hàng -->
  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <h5 class="font-semibold text-lg mb-3 flex items-center text-purple-400">
      <i data-lucide="users" class="w-5 h-5 mr-2"></i>Top khách hàng tháng này
    </h5>
    <div class="h-80">
      <canvas id="topCustomersChart"></canvas>
    </div>
  </div>

  <!-- Phân bố trạng thái đơn hàng -->
  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <h5 class="font-semibold text-lg mb-3 flex items-center text-yellow-400">
      <i data-lucide="pie-chart" class="w-5 h-5 mr-2"></i>Phân bố trạng thái
    </h5>
    <div class="h-80 flex items-center justify-center">
      <canvas id="statusChart"></canvas>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  lucide.createIcons();

  // Parse data from backend
  const revenueData = {{ revenue_timeline_chart|default:'[]' }};
  const topProductsData = {{ top_products_chart|default:'[]' }};
  const topCustomersData = {{ top_customers_chart|default:'[]' }};
  const statusData = {{ status_breakdown_chart|default:'[]' }};

  // Calculate totals
  let totalRevenue30Days = 0;
  let totalOrders30Days = 0;
  if (revenueData && revenueData.length > 0) {
    revenueData.forEach(d => {
      totalRevenue30Days += d.revenue || 0;
      totalOrders30Days += d.order_count || 0;
    });
    
    // Display totals
    const totalRevenueEl = document.getElementById('totalRevenue');
    const totalOrdersEl = document.getElementById('totalOrders');
    if (totalRevenueEl) {
      totalRevenueEl.textContent = (totalRevenue30Days / 1000000).toFixed(1) + 'Mđ';
    }
    if (totalOrdersEl) {
      totalOrdersEl.textContent = totalOrders30Days.toLocaleString('vi-VN');
    }
  }

  // Revenue chart (30 days)
  if (revenueData && revenueData.length > 0) {
    const ctx1 = document.getElementById('revenueChart');
    new Chart(ctx1, {
      type: 'line',
      data: {
        labels: revenueData.map(d => {
          const date = new Date(d.day);
          return date.getDate() + '/' + (date.getMonth() + 1);
        }),
        datasets: [{
          label: 'Doanh thu (đ)',
          data: revenueData.map(d => d.revenue),
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + 'đ';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return (value / 1000000).toFixed(1) + 'M';
              }
            }
          }
        }
      }
    });
  }

  // Order count chart (30 days)
  if (revenueData && revenueData.length > 0) {
    const ctx1b = document.getElementById('orderCountChart');
    new Chart(ctx1b, {
      type: 'bar',
      data: {
        labels: revenueData.map(d => {
          const date = new Date(d.day);
          return date.getDate() + '/' + (date.getMonth() + 1);
        }),
        datasets: [{
          label: 'Số đơn',
          data: revenueData.map(d => d.order_count),
          backgroundColor: '#f59e0b',
          borderRadius: 4,
          maxBarThickness: 40,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Số đơn: ' + context.parsed.y;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });
  }

  // Top products chart with custom tooltip
  if (topProductsData && topProductsData.length > 0) {
    const ctx2 = document.getElementById('topProductsChart');
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: topProductsData.map(p => p.product__code || p.product__name || 'SP'),
        datasets: [{
          label: 'Doanh thu thuần (đ)',
          data: topProductsData.map(p => p.net_revenue),
          backgroundColor: '#3b82f6',
          maxBarThickness: 40,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: false,
            external: function(context) {
              let tooltipEl = document.getElementById('chartjs-tooltip-products');
              if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'chartjs-tooltip-products';
                tooltipEl.style.cssText = 'position:absolute;background:rgba(0,0,0,0.9);color:#fff;border-radius:6px;padding:10px;pointer-events:none;transition:opacity 0.2s;z-index:9999;max-width:280px;';
                document.body.appendChild(tooltipEl);
              }

              const tooltipModel = context.tooltip;
              if (tooltipModel.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
              }

              if (tooltipModel.body) {
                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                const product = topProductsData[dataIndex];
                const lines = [];

                if (product.image) {
                  lines.push('<img src="' + product.image + '" style="width:100%;max-width:200px;height:auto;border-radius:4px;margin-bottom:8px;" onerror="this.style.display=\'none\'" />');
                }

                lines.push('<div style="font-weight:600;margin-bottom:4px;">' + (product.product__name || 'Sản phẩm') + '</div>');
                lines.push('<div style="font-size:11px;color:#9ca3af;margin-bottom:6px;">Mã: ' + (product.product__code || '-') + '</div>');
                lines.push('<div style="font-size:12px;margin:2px 0;"><span style="color:#10b981;">●</span> Doanh thu: ' + product.net_revenue.toLocaleString('vi-VN') + 'đ</div>');
                lines.push('<div style="font-size:12px;margin:2px 0;"><span style="color:#60a5fa;">●</span> Số đơn: ' + product.order_count + '</div>');
                lines.push('<div style="font-size:12px;margin:2px 0;"><span style="color:#f97316;">●</span> Tổng SL: ' + product.total_amount + '</div>');

                tooltipEl.innerHTML = lines.join('');
              }

              const position = context.chart.canvas.getBoundingClientRect();
              tooltipEl.style.opacity = 1;
              tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
              tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return (value / 1000000).toFixed(1) + 'M';
              }
            }
          }
        },
        onClick: function(event, elements) {
          if (elements.length > 0) {
            const dataIndex = elements[0].index;
            const product = topProductsData[dataIndex];
            if (product && product.product_id) {
              window.location.href = '/san-pham/' + product.product_id;
            }
          }
        }
      }
    });
  }

  // Top customers chart with custom tooltip
  if (topCustomersData && topCustomersData.length > 0) {
    const ctx3 = document.getElementById('topCustomersChart');
    new Chart(ctx3, {
      type: 'bar',
      data: {
        labels: topCustomersData.map(c => c.customer__code || c.customer__name || 'KH'),
        datasets: [{
          label: 'Doanh thu thuần (đ)',
          data: topCustomersData.map(c => c.net_revenue),
          backgroundColor: '#a855f7',
          maxBarThickness: 40,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: false,
            external: function(context) {
              let tooltipEl = document.getElementById('chartjs-tooltip-customers');
              if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'chartjs-tooltip-customers';
                tooltipEl.style.cssText = 'position:absolute;background:rgba(0,0,0,0.9);color:#fff;border-radius:6px;padding:10px;pointer-events:none;transition:opacity 0.2s;z-index:9999;max-width:280px;';
                document.body.appendChild(tooltipEl);
              }

              const tooltipModel = context.tooltip;
              if (tooltipModel.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
              }

              if (tooltipModel.body) {
                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                const customer = topCustomersData[dataIndex];
                const lines = [];

                lines.push('<div style="font-weight:600;margin-bottom:4px;">' + (customer.customer__name || 'Khách hàng') + '</div>');
                lines.push('<div style="font-size:11px;color:#9ca3af;margin-bottom:6px;">Mã: ' + (customer.customer__code || '-') + '</div>');
                lines.push('<div style="font-size:12px;margin:2px 0;"><span style="color:#10b981;">●</span> Doanh thu: ' + customer.net_revenue.toLocaleString('vi-VN') + 'đ</div>');
                lines.push('<div style="font-size:12px;margin:2px 0;"><span style="color:#60a5fa;">●</span> Số đơn: ' + customer.order_count + '</div>');
                lines.push('<div style="font-size:12px;margin:2px 0;"><span style="color:#f97316;">●</span> Tổng SL: ' + customer.total_amount + '</div>');

                tooltipEl.innerHTML = lines.join('');
              }

              const position = context.chart.canvas.getBoundingClientRect();
              tooltipEl.style.opacity = 1;
              tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
              tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return (value / 1000000).toFixed(1) + 'M';
              }
            }
          }
        },
        onClick: function(event, elements) {
          if (elements.length > 0) {
            const dataIndex = elements[0].index;
            const customer = topCustomersData[dataIndex];
            if (customer && customer.customer__code) {
              window.location.href = '/khach-hang/' + customer.customer__code;
            }
          }
        }
      }
    });
  }

  // Status breakdown chart
  if (statusData && statusData.length > 0) {
    const ctx4 = document.getElementById('statusChart');
    const statusColors = {
      'created': '#6b7280',
      'cart': '#f59e0b',
      'purchased': '#3b82f6',
      'in_stock': '#6366f1',
      'reported': '#a855f7',
      'reconciled': '#10b981',
      'cancelled': '#ef4444',
    };
    
    new Chart(ctx4, {
      type: 'doughnut',
      data: {
        labels: statusData.map(s => s.label),
        datasets: [{
          data: statusData.map(s => s.order_count),
          backgroundColor: statusData.map(s => statusColors[s.status] || '#64748b'),
          borderWidth: 2,
          borderColor: '#121212',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: { size: 12 }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return label + ': ' + value + ' đơn (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
