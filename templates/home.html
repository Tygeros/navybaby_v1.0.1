{% extends 'base.html' %}
{% load number_extras %}
{% block title %}Bảng điều khiển - NavyBaby{% endblock %}
{% block navbar_icon %}gauge{% endblock %}
{% block navbar_title %}Tổng quan{% endblock %}
{% block content %}

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-6">
  <div>
    <h2 class="text-2xl font-bold flex items-center text-blue-400">
      <i data-lucide="pie-chart" class="w-6 h-6 mr-2"></i>Bảng điều khiển
    </h2>
    <p class="text-gray-400">Tổng quan về hoạt động kinh doanh</p>
  </div>
  <span class="bg-blue-900/30 text-blue-300 px-3 py-1 rounded-md text-sm font-medium border border-blue-800">NavyBaby v1.0.1</span>
</div>

<!-- Thống kê -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <a href="{% url 'customers:customer_list' %}" class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700 block">
    <i data-lucide="users" class="w-8 h-8 text-blue-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ total_customers }}</h4>
    <p class="text-gray-400 text-sm">Khách hàng</p>
  </a>

  <a href="{% url 'products:product_list' %}" class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700 block">
    <i data-lucide="warehouse" class="w-8 h-8 text-green-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ total_products }}</h4>
    <p class="text-gray-400 text-sm">Sản phẩm</p>
  </a>

  <a href="{% url 'orders:order_list' %}" class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700 block">
    <i data-lucide="shopping-cart" class="w-8 h-8 text-yellow-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ total_orders }}</h4>
    <p class="text-gray-400 text-sm">Đơn hàng</p>
  </a>

  <div class="bg-[#161616] border border-gray-800 rounded-lg text-center p-4 transition hover:-translate-y-0.5 hover:border-gray-700">
    <i data-lucide="coins" class="w-8 h-8 text-purple-400 mx-auto mb-2"></i>
    <h4 class="font-bold text-xl text-gray-100">{{ net_profit|default:0|smart_vnd }}</h4>
    <p class="text-gray-400 text-sm flex items-center justify-center gap-1" title="Tổng lợi nhuận tạm tính của toàn bộ các đơn hàng chưa đối soát. (Chỉ áp dụng đối với các đơn hàng có sản phẩm với trường giá nhập > 0)">
      Lãi ròng ước tính
      <i data-lucide="help-circle" class="w-4 h-4 text-gray-500"></i>
    </p>
  </div>
</div>

<!-- Thao tác nhanh -->
<div class="bg-[#121212] border border-gray-800 rounded-lg p-4 mb-6">
  <h5 class="font-semibold text-lg mb-3 flex items-center text-blue-400">
    <i data-lucide="zap" class="w-5 h-5 mr-2"></i>Thao tác nhanh
  </h5>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <a href="{% url 'customers:customer_create' %}" class="border border-gray-800 bg-[#161616] rounded-lg p-3 text-center transition hover:-translate-y-0.5 hover:border-gray-700 hover:bg-[#1e1e1e]">
      <i data-lucide="user-plus" class="w-7 h-7 text-blue-400 mx-auto mb-2"></i>
      <p class="text-gray-300">Thêm khách hàng</p>
    </a>

    <a href="{% url 'products:product_create' %}" class="border border-gray-800 bg-[#161616] rounded-lg p-3 text-center transition hover:-translate-y-0.5 hover:border-gray-700 hover:bg-[#1e1e1e] group">
      <i data-lucide="package-plus" class="w-7 h-7 text-green-400 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
      <p class="text-gray-300 group-hover:text-white">Thêm sản phẩm</p>
    </a>

    <a href="{% url 'orders:order_create' %}" class="border border-gray-800 bg-[#161616] rounded-lg p-3 text-center transition hover:-translate-y-0.5 hover:border-gray-700 hover:bg-[#1e1e1e] group">
      <i data-lucide="shopping-bag" class="w-7 h-7 text-yellow-400 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
      <p class="text-gray-300 group-hover:text-white">Tạo đơn hàng</p>
    </a>

    <a href="{% url 'finance:transactions_list' %}" class="border border-gray-800 bg-[#161616] rounded-lg p-3 text-center transition hover:-translate-y-0.5 hover:border-gray-700 hover:bg-[#1e1e1e] group" title="Tính năng đang phát triển">
      <i data-lucide="circle-plus" class="w-7 h-7 text-purple-400 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
      <p class="text-gray-300 group-hover:text-white">Thêm giao dịch mới</p>
    </a>
  </div>
</div>

<!-- Thống kê & Biểu đồ -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <h5 class="font-semibold text-lg mb-3 flex items-center text-blue-400">
      <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i>Khách hàng mới (so sánh kỳ)
    </h5>
    <div class="grid grid-cols-1 gap-3">
      <canvas id="customersChart" height="120"></canvas>
    </div>
  </div>

  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4">
    <h5 class="font-semibold text-lg mb-3 flex items-center text-green-400">
      <i data-lucide="bar-chart" class="w-5 h-5 mr-2"></i>Sản phẩm mới (so sánh kỳ)
    </h5>
    <div class="grid grid-cols-1 gap-3">
      <canvas id="productsChart" height="120"></canvas>
    </div>
  </div>

  <div class="bg-[#121212] border border-gray-800 rounded-lg p-4 xl:col-span-2">
    <h5 class="font-semibold text-lg mb-3 flex items-center text-yellow-400">
      <i data-lucide="activity" class="w-5 h-5 mr-2"></i>Đơn hàng (số lượng & giá trị)
    </h5>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div>
        <p class="text-sm text-gray-400 mb-2">Số lượng đơn</p>
        <canvas id="ordersCountChart" height="140"></canvas>
      </div>
      <div>
        <p class="text-sm text-gray-400 mb-2">Giá trị đơn (₫)</p>
        <canvas id="ordersValueChart" height="140"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Top sản phẩm bán chạy trong tháng -->
<div class="bg-[#121212] border border-gray-800 rounded-lg p-4 mb-8">
  <h5 class="font-semibold text-lg mb-3 flex items-center text-purple-400">
    <i data-lucide="trophy" class="w-5 h-5 mr-2"></i>Top sản phẩm bán chạy trong tháng
  </h5>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-800 text-sm">
      <thead class="bg-[#161616]">
        <tr>
          <th class="px-4 py-2 text-left text-gray-400 uppercase tracking-wider">#</th>
          <th class="px-4 py-2 text-left text-gray-400 uppercase tracking-wider">Sản phẩm</th>
          <th class="px-4 py-2 text-right text-gray-400 uppercase tracking-wider">Số lượng</th>
          <th class="px-4 py-2 text-right text-gray-400 uppercase tracking-wider">Giá trị</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-800">
        {% for p in top_products_month %}
          <tr>
            <td class="px-4 py-2 text-gray-400">{{ forloop.counter }}</td>
            <td class="px-4 py-2 text-gray-200">{{ p.product__name }}</td>
            <td class="px-4 py-2 text-right text-gray-100">{{ p.total_amount|default:0 }}</td>
            <td class="px-4 py-2 text-right text-green-400">{{ p.total_value|default:0|smart_vnd }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="px-4 py-4 text-center text-gray-400">Chưa có dữ liệu trong tháng này.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <p class="text-xs text-gray-500 mt-2">Không tính các đơn hàng đã đối soát hoặc hủy.</p>
  </div>

{% endblock %}

<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{{ customer_stats|json_script:"customer-stats-data" }}
{{ product_stats|json_script:"product-stats-data" }}
{{ order_stats|json_script:"order-stats-data" }}
<script>
  if (window.lucide) { try { lucide.createIcons(); } catch (e) {} }
  // Prepare data from context
  const customerStats = JSON.parse(document.getElementById('customer-stats-data').textContent);
  const productStats = JSON.parse(document.getElementById('product-stats-data').textContent);
  const orderStats = JSON.parse(document.getElementById('order-stats-data').textContent);

  function uiPalette() {
    const theme = document.documentElement.getAttribute('data-theme') || 'dark';
    if (theme === 'light') {
      return { legend: '#374151', tick: '#4b5563', grid: '#e5e7eb' };
    }
    return { legend: '#d1d5db', tick: '#9ca3af', grid: '#1f2937' };
  }

  function applyScales(baseOptions) {
    const p = uiPalette();
    baseOptions.plugins = baseOptions.plugins || {};
    baseOptions.plugins.legend = baseOptions.plugins.legend || {};
    baseOptions.plugins.legend.labels = Object.assign({ color: p.legend }, baseOptions.plugins.legend.labels || {});
    baseOptions.scales = baseOptions.scales || {};
    baseOptions.scales.x = Object.assign({
      ticks: { color: p.tick },
      grid: { color: p.grid }
    }, baseOptions.scales.x || {});
    baseOptions.scales.y = Object.assign({
      ticks: Object.assign({ color: p.tick }, (baseOptions.scales.y && baseOptions.scales.y.ticks) || {}),
      grid: { color: p.grid }
    }, baseOptions.scales.y || {});
    return baseOptions;
  }

  function makeBarChart(ctx, labels, currentData, previousData, colors) {
    const options = applyScales({
      responsive: true,
      plugins: {
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString('vi-VN')}` } }
      },
      scales: {
        y: { ticks: { callback: v => v.toLocaleString('vi-VN') } }
      }
    });
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Kỳ này', data: currentData, backgroundColor: colors[0], borderColor: colors[0] },
          { label: 'Kỳ trước', data: previousData, backgroundColor: colors[1], borderColor: colors[1] }
        ]
      },
      options
    });
  }

  // Customers chart: Today/This Week/This Month vs previous
  const custLabels = ['Hôm nay', 'Tuần này', 'Tháng này'];
  const custCurrent = [customerStats.today, customerStats.this_week, customerStats.this_month];
  const custPrev = [customerStats.yesterday, customerStats.last_week, customerStats.last_month];
  const customersChart = makeBarChart(document.getElementById('customersChart'), custLabels, custCurrent, custPrev, ['#60a5fa', '#334155']);

  // Products chart
  const prodCurrent = [productStats.today, productStats.this_week, productStats.this_month];
  const prodPrev = [productStats.yesterday, productStats.last_week, productStats.last_month];
  const productsChart = makeBarChart(document.getElementById('productsChart'), custLabels, prodCurrent, prodPrev, ['#34d399', '#374151']);

  // Orders count chart (bar)
  const ordLabels = ['Hôm nay', 'Tuần này', 'Tháng này'];
  const ordCountCurrent = [orderStats.today.count, orderStats.this_week.count, orderStats.this_month.count];
  const ordCountPrev = [orderStats.yesterday.count, orderStats.last_week.count, orderStats.last_month.count];
  makeBarChart(document.getElementById('ordersCountChart'), ordLabels, ordCountCurrent, ordCountPrev, ['#f59e0b', '#374151']);

  // Orders value chart (line vs bar)
  const ordersValueChart = new Chart(document.getElementById('ordersValueChart'), {
    type: 'bar',
    data: {
      labels: ordLabels,
      datasets: [
        {
          type: 'line',
          label: 'Giá trị (₫) - Kỳ này',
          data: [orderStats.today.value, orderStats.this_week.value, orderStats.this_month.value],
          borderColor: '#10b981',
          backgroundColor: 'transparent',
          tension: 0.3,
          yAxisID: 'y',
        },
        {
          type: 'line',
          label: 'Giá trị (₫) - Kỳ trước',
          data: [orderStats.yesterday.value, orderStats.last_week.value, orderStats.last_month.value],
          borderColor: '#4b5563',
          backgroundColor: 'transparent',
          borderDash: [4,4],
          tension: 0.3,
          yAxisID: 'y',
        }
      ]
    },
    options: applyScales({
      responsive: true,
      plugins: {
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.parsed.y||0).toLocaleString('vi-VN')} ₫` } }
      },
      scales: {
        y: { ticks: { callback: v => `${Number(v).toLocaleString('vi-VN')} ₫` } }
      }
    })
  });

  // React to theme changes
  window.addEventListener('themechange', function() {
    const charts = [customersChart, productsChart, ordersValueChart];
    const p = uiPalette();
    charts.forEach(ch => {
      if (!ch) return;
      if (ch.options.plugins && ch.options.plugins.legend && ch.options.plugins.legend.labels) {
        ch.options.plugins.legend.labels.color = p.legend;
      }
      if (ch.options.scales && ch.options.scales.x) {
        if (ch.options.scales.x.ticks) ch.options.scales.x.ticks.color = p.tick;
        if (ch.options.scales.x.grid) ch.options.scales.x.grid.color = p.grid;
      }
      if (ch.options.scales && ch.options.scales.y) {
        if (ch.options.scales.y.ticks && typeof ch.options.scales.y.ticks === 'object') {
          ch.options.scales.y.ticks.color = p.tick;
        }
        if (ch.options.scales.y.grid) ch.options.scales.y.grid.color = p.grid;
      }
      ch.update();
    });
  });
</script>
