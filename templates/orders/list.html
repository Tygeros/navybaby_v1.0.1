{% extends 'base.html' %}
{% load number_extras %}
{% load media_extras %}
{% block title %}Danh sách đơn hàng - NavyBaby{% endblock %}
{% block navbar_icon %}file-text{% endblock %}
{% block navbar_title %}Đơn hàng{% endblock %}

{% block content %}
<!-- Header -->
<div class="sticky-subheader flex flex-col md:flex-row justify-between items-start md:items-center mb-6 py-3">
  <div>
    <h2 class="text-2xl font-bold flex items-center text-blue-400 mb-1">
      <i data-lucide="shopping-cart" class="w-6 h-6 mr-2"></i>Đơn hàng
    </h2>
    <p class="text-gray-400 text-sm">Quản lý đơn hàng</p>
  </div>
  <div class="flex items-center gap-2 mt-3 md:mt-0">
    <a href="?display=table"
       class="px-3 py-1.5 rounded-md border text-sm transition
       {% if display == 'table' %}
         bg-blue-900/30 text-blue-300 border-blue-800
       {% else %}
         bg-[#161616] text-gray-300 border-gray-800 hover:border-gray-700
       {% endif %}">
      <i data-lucide="table" class="inline w-4 h-4 mr-1"></i>Bảng
    </a>
    <a href="?display=card"
       class="px-3 py-1.5 rounded-md border text-sm transition
       {% if display == 'card' %}
         bg-blue-900/30 text-blue-300 border-blue-800
       {% else %}
         bg-[#161616] text-gray-300 border-gray-800 hover:border-gray-700
       {% endif %}">
      <i data-lucide="grid" class="inline w-4 h-4 mr-1"></i>Thẻ
    </a>
    <a href="{% url 'orders:order_create' %}"
       class="px-3 py-1.5 rounded-md border text-sm transition
       bg-blue-600 text-white border-blue-700 hover:bg-blue-500 flex items-center shadow-sm hover:shadow-blue-700/30">
      <i data-lucide="plus" class="inline w-4 h-4 mr-1"></i>Tạo đơn hàng
    </a>
    <button type="button" id="btn-toggle-multi"
       class="px-3 py-1.5 rounded-md border text-sm transition bg-[#161616] text-gray-300 border-gray-800 hover:border-gray-700">
      <i data-lucide="check-square" class="inline w-4 h-4 mr-1"></i>Chọn nhiều đơn hàng
    </button>
    <button type="button" id="btn-select-all" class="px-3 py-1.5 rounded-md border text-sm transition bg-[#161616] text-gray-300 border-gray-800 hover:border-gray-700 multi-only hidden">
      <i data-lucide="check" class="inline w-4 h-4 mr-1"></i>Chọn toàn bộ
    </button>
   </div>
</div>

<!-- Filters -->
<div class="bg-[#121212] border border-gray-800 rounded-xl p-5 mb-6 shadow-inner shadow-black/20">
  <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-4">
    <div class="md:col-span-2 relative">
      <i data-lucide="search" class="w-4 h-4 text-gray-500 absolute left-2.5 top-2.5"></i>
      <input type="text" name="q" value="{{ search_query }}" placeholder="Tìm theo mã đơn, khách hàng, sản phẩm, trạng thái..."
        class="w-full bg-[#161616] border border-gray-800 rounded-md pl-8 pr-3 py-2 text-sm text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-gray-700 transition">
    </div>
    <div class="relative" data-dropdown="status">
      <button type="button" data-dropdown-toggle="#dd-status" class="w-full bg-[#161616] border border-gray-800 rounded-md px-3 py-2 text-sm text-gray-200 text-left flex items-center justify-between hover:border-gray-700 transition">
        <span>Trạng thái{% if status_filter %} ({{ status_filter|length }}){% endif %}</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" /></svg>
      </button>
      <div id="dd-status" data-dropdown-panel class="hidden absolute z-20 mt-1 w-[22rem] max-w-[calc(100vw-2rem)] bg-[#161616] border border-gray-800 rounded-md p-3 shadow-xl">
        <div class="mb-2">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" data-select-all="status" class="h-4 w-4 rounded border-gray-700 bg-[#121212] text-blue-600 focus:ring-blue-500/40">
            <span class="text-gray-300">Tất cả các trạng thái</span>
          </label>
        </div>
        <div class="grid grid-cols-2 gap-2 max-h-56 overflow-auto" data-group="status">
          {% for value,label in status_choices.items %}
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="status" value="{{ value }}" class="h-4 w-4 rounded border-gray-700 bg-[#121212] text-blue-600 focus:ring-blue-500/40" {% if value in status_filter %}checked{% endif %}>
              <span class="text-gray-300">{{ label }}</span>
            </label>
          {% endfor %}
        </div>
        <div class="mt-3 flex justify-end">
          <button type="button" data-dropdown-close="#dd-status" class="px-3 py-1.5 rounded-md border text-xs bg-[#1a1a1a] text-gray-300 border-gray-800 hover:border-gray-700">Đóng</button>
        </div>
      </div>
    </div>
    <div class="relative" data-dropdown="supplier">
      <button type="button" data-dropdown-toggle="#dd-supplier" class="w-full bg-[#161616] border border-gray-800 rounded-md px-3 py-2 text-sm text-gray-200 text-left flex items-center justify-between hover:border-gray-700 transition">
        <span>Nhà cung cấp{% if supplier_filter %} ({{ supplier_filter|length }}){% endif %}</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" /></svg>
      </button>
      <div id="dd-supplier" data-dropdown-panel class="hidden absolute z-20 mt-1 w-72 max-w-[calc(100vw-2rem)] bg-[#161616] border border-gray-800 rounded-md p-3 shadow-xl">
        <div class="mb-2">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" data-select-all="supplier" class="h-4 w-4 rounded border-gray-700 bg-[#121212] text-blue-600 focus:ring-blue-500/40">
            <span class="text-gray-300">Tất cả NCC</span>
          </label>
        </div>
        <div class="mb-2">
          <div class="relative">
            <i data-lucide="search" class="w-4 h-4 text-gray-500 absolute left-2 top-2.5"></i>
            <input type="text" placeholder="Tìm NCC..." data-filter-input="supplier" class="w-full bg-[#151515] border border-gray-800 rounded pl-8 pr-2 py-1.5 text-sm text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-gray-700" />
          </div>
        </div>
        <div class="flex flex-col gap-2 max-h-56 overflow-auto" data-group="supplier">
          {% for s in suppliers %}
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="supplier" value="{{ s.id }}" class="h-4 w-4 rounded border-gray-700 bg-[#121212] text-blue-600 focus:ring-blue-500/40" {% if s.id|stringformat:"s" in supplier_filter %}checked{% endif %}>
              <span class="text-gray-300">{{ s.name }}</span>
            </label>
          {% endfor %}
        </div>
        <div class="mt-3 flex justify-end">
          <button type="button" data-dropdown-close="#dd-supplier" class="px-3 py-1.5 rounded-md border text-xs bg-[#1a1a1a] text-gray-300 border-gray-800 hover:border-gray-700">Đóng</button>
        </div>
      </div>
    </div>
    <div>
      <select name="sort" class="w-full bg-[#161616] border border-gray-800 rounded-md px-3 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-gray-700 transition">
        <option value="updated_desc" {% if sort == 'updated_desc' %}selected{% endif %}>Cập nhật gần nhất</option>
        <option value="updated_asc" {% if sort == 'updated_asc' %}selected{% endif %}>Cập nhật cũ nhất</option>
        <option value="created_desc" {% if sort == 'created_desc' %}selected{% endif %}>Tạo gần nhất</option>
        <option value="created_asc" {% if sort == 'created_asc' %}selected{% endif %}>Tạo cũ nhất</option>
        <option value="revenue_desc" {% if sort == 'revenue_desc' %}selected{% endif %}>Doanh thu giảm dần</option>
        <option value="revenue_asc" {% if sort == 'revenue_asc' %}selected{% endif %}>Doanh thu tăng dần</option>
      </select>
    </div>
    <div>
      <select name="group_by" class="w-full bg-[#161616] border border-gray-800 rounded-md px-3 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-gray-700 transition">
        <option value="" {% if not group_by %}selected{% endif %}>Không nhóm</option>
        <option value="customer" {% if group_by == 'customer' %}selected{% endif %}>Nhóm theo Khách hàng</option>
        <option value="product" {% if group_by == 'product' %}selected{% endif %}>Nhóm theo Sản phẩm</option>
      </select>
    </div>
    <div class="md:col-span-5 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <input type="date" name="date_from" value="{{ date_from }}" class="w-full bg-[#161616] border border-gray-800 rounded-md px-3 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-gray-700 transition" />
        <span class="text-gray-500">-</span>
        <input type="date" name="date_to" value="{{ date_to }}" class="w-full bg-[#161616] border border-gray-800 rounded-md px-3 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-gray-700 transition" />
      </div>
      <div class="flex justify-end gap-2">
        <a href="{% url 'orders:order_list' %}" class="px-3 py-2 rounded-md border text-sm bg-[#161616] text-gray-300 border-gray-800 hover:border-gray-700 transition">Xóa lọc</a>
        <button class="px-3 py-2 rounded-md border text-sm bg-blue-600 text-white border-blue-700 hover:bg-blue-500 transition">Lọc</button>
      </div>
    </div>
    {% if status_filter or supplier_filter %}
    <div class="md:col-span-6 flex flex-wrap items-center gap-2 pt-1">
      {% if status_filter %}
        {% for value,label in status_choices.items %}
          {% if value in status_filter %}
            <span class="px-2 py-1 text-xs rounded border border-gray-800 bg-[#161616] text-gray-300">{{ label }}</span>
          {% endif %}
        {% endfor %}
      {% endif %}
      {% if supplier_filter %}
        {% for s in suppliers %}
          {% if s.id|stringformat:"s" in supplier_filter %}
            <span class="px-2 py-1 text-xs rounded border border-gray-800 bg-[#161616] text-gray-300">{{ s.name }}</span>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
    {% endif %}
  </form>
</div>

<script>
  (function() {
    function toggle(el) { el.classList.toggle('hidden'); }
    document.querySelectorAll('[data-dropdown-toggle]').forEach(function(btn){
      var target = document.querySelector(btn.getAttribute('data-dropdown-toggle'));
      btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(target); });
    });
    // Prevent closing when clicking inside the dropdown panel
    document.querySelectorAll('[data-dropdown-panel]').forEach(function(panel){
      panel.addEventListener('click', function(e){ e.stopPropagation(); });
    });
    document.addEventListener('click', function(){
      document.querySelectorAll('[id^="dd-"]').forEach(function(p){ if(!p.classList.contains('hidden')) p.classList.add('hidden'); });
    });
    // Explicit close buttons
    document.querySelectorAll('[data-dropdown-close]').forEach(function(btn){
      var target = document.querySelector(btn.getAttribute('data-dropdown-close'));
      btn.addEventListener('click', function(e){ e.stopPropagation(); if(target) target.classList.add('hidden'); });
    });
    document.querySelectorAll('[data-select-all]').forEach(function(all){
      var group = all.getAttribute('data-select-all');
      var container = all.closest('[data-dropdown]');
      var list = container ? container.querySelector('[data-group="'+group+'"]') : null;
      function syncAllState(){
        if(!list) return;
        var boxes = list.querySelectorAll('input[type="checkbox"]');
        var checked = Array.from(boxes).every(function(b){ return b.checked; });
        all.checked = checked;
      }
      if(list){
        all.addEventListener('change', function(){
          var boxes = list.querySelectorAll('input[type="checkbox"]');
          boxes.forEach(function(b){ b.checked = all.checked; });
        });
        list.addEventListener('change', syncAllState);
        syncAllState();
      }
    });
    // Live filter for supplier list
    document.querySelectorAll('[data-filter-input]').forEach(function(inp){
      var group = inp.getAttribute('data-filter-input');
      var container = inp.closest('[data-dropdown]');
      var list = container ? container.querySelector('[data-group="'+group+'"]') : null;
      if(!list) return;
      inp.addEventListener('input', function(){
        var q = (inp.value || '').toLowerCase().trim();
        list.querySelectorAll('label').forEach(function(lbl){
          var text = (lbl.textContent || '').toLowerCase();
          lbl.classList.toggle('hidden', q && text.indexOf(q) === -1);
        });
      });
    });
  })();
</script>

<!-- Totals summary for filtered list -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-3 text-center">
    <p class="text-[11px] text-gray-400">Số đơn</p>
    <p class="text-lg font-semibold text-gray-100">{{ list_totals.order_count|default:0 }}</p>
  </div>
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-3 text-center">
    <p class="text-[11px] text-gray-400">Số lượng</p>
    <p class="text-lg font-semibold text-gray-100">{{ list_totals.total_amount|default:0 }}</p>
  </div>
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-3 text-center">
    <p class="text-[11px] text-gray-400">Doanh thu</p>
    <p class="text-lg font-semibold text-green-400">{% if request.user.account_type == 'staff' %}__{% else %}{{ list_totals.total_revenue|default:0|smart_vnd }}{% endif %}</p>
  </div>
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-3 text-center">
    <p class="text-[11px] text-gray-400">Chiết khấu</p>
    <p class="text-lg font-semibold text-yellow-300">{{ list_totals.total_discount|default:0|smart_vnd }}</p>
  </div>
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-3 text-center">
    <p class="text-[11px] text-gray-400">Doanh thu thuần</p>
    <p class="text-lg font-semibold text-emerald-400">{% if request.user.account_type == 'staff' %}__{% else %}{{ list_totals.total_net_profit|default:0|smart_vnd }}{% endif %}</p>
  </div>
</div>

{% if group_by %}
  <div class="bg-[#121212] border border-gray-800 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-800">
        <thead class="bg-[#161616]">
          <tr>
            {% if group_by == 'customer' %}
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Khách hàng</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Mã KH</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">SĐT</th>
            {% else %}
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Sản phẩm</th>
            {% endif %}
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Số đơn</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Số lượng</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Doanh thu</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Chiết khấu</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Doanh thu thuần</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
          {% for g in grouped_results %}
            <tr class="hover:bg-[#171717]">
              {% if group_by == 'customer' %}
                <td class="px-4 py-3 text-sm text-gray-300">
                  {% if g.customer__name %}
                    <a href="{% url 'customers:customer_detail' g.customer__code %}?{{ filters_qs }}" class="text-blue-400 hover:text-blue-300 hover:underline underline-offset-2">{{ g.customer__name }}</a>
                  {% else %}-{% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">{{ g.customer__code|default:'-' }}</td>
                <td class="px-4 py-3 text-sm text-gray-300">{{ g.customer__phone_number|default:'-' }}</td>
              {% else %}
                <td class="px-4 py-3 text-sm text-gray-300">
                  <div class="flex items-center gap-2">
                    {% if g.product__image %}
                      <img src="{{ g.product__image|safe_image_url }}" alt="{{ g.product__name }}" class="w-10 h-10 object-cover rounded border border-gray-800">
                    {% else %}
                      <div class="w-10 h-10 bg-[#1e1e1e] rounded border border-gray-800 flex items-center justify-center text-gray-500">
                        <i data-lucide="image" class="w-4 h-4"></i>
                      </div>
                    {% endif %}
                    <div>
                      <div>
                        <a href="{% url 'products:product_detail' g.product_id %}?{{ filters_qs }}" class="text-blue-400 hover:text-blue-300 hover:underline underline-offset-2">{{ g.product__name|default:'-' }}</a>
                      </div>
                      <div class="text-xs text-gray-500"><span class="text-gray-400">{{ g.product__code|default:'-' }}</span></div>
                      <div class="text-xs text-gray-500">{{ g.product__supplier__name|default:'-' }}</div>
                    </div>
                  </div>
                </td>
              {% endif %}
              <td class="px-4 py-3 text-sm text-gray-300">{{ g.order_count|default:0 }}</td>
              <td class="px-4 py-3 text-sm text-gray-300">{{ g.total_amount|default:0 }}</td>
              <td class="px-4 py-3 text-sm"><span class="text-green-400 font-medium">{{ g.total_revenue|default:0|smart_vnd }}</span></td>
              <td class="px-4 py-3 text-sm"><span class="text-yellow-300 font-medium">{{ g.total_discount|default:0|smart_vnd }}</span></td>
              <td class="px-4 py-3 text-sm"><span class="text-emerald-400 font-medium">{% if request.user.account_type == 'staff' %}__{% else %}{{ g.total_net_profit|default:0|smart_vnd }}{% endif %}</span></td>
            </tr>
          {% empty %}
            <tr>
              <td {% if group_by == 'customer' %}colspan="7"{% else %}colspan="6"{% endif %} class="px-4 py-6 text-center text-gray-400">Không có dữ liệu nhóm.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}

<form id="bulk-form" method="post" action="{% url 'orders:bulk_update_order_status' %}" class="mb-3 hidden">
  {% csrf_token %}
  <div id="bulk-actions" class="bg-[#121212] border border-gray-800 rounded-lg p-3 flex items-center gap-3">
    <div class="text-sm text-gray-300">Áp dụng trạng thái cho đơn đã chọn</div>
    <select name="status" id="bulk-status" class="bg-[#161616] border border-gray-800 rounded px-3 py-2 text-sm text-gray-200">
      {% for value,label in status_choices.items %}
        <option value="{{ value }}">{{ label }}</option>
      {% endfor %}
    </select>
    <button type="submit" id="bulk-submit" class="px-3 py-2 rounded-md border text-sm bg-blue-600 text-white border-blue-700 hover:bg-blue-500">Cập nhật trạng thái</button>
    <div id="bulk-ids"></div>
  </div>
  <input type="hidden" name="_bulk" value="1" />
  <input type="hidden" name="next" value="{{ request.get_full_path }}" />
</form>

{% if display == 'card' %}
  <!-- Card mode -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for order in orders %}
      <div class="bg-[#161616] border border-gray-800 rounded-lg p-4 transition hover:-translate-y-0.5 hover:border-gray-700">
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-3">
            <input type="checkbox" class="order-check multi-only hidden mt-1 cursor-pointer" data-id="{{ order.id }}" style="transform: scale(1.25); transform-origin: left top;" />
            {% if order.product.image %}
              <img src="{{ order.product.image|safe_image_url }}" alt="{{ order.product.name }}" class="w-12 h-12 object-cover rounded border border-gray-800">
            {% else %}
              <div class="w-12 h-12 bg-[#1e1e1e] rounded border border-gray-800 flex items-center justify-center text-gray-500">
                <i data-lucide="image" class="w-5 h-5"></i>
              </div>
            {% endif %}
            <div>
              <a href="{% url 'orders:order_detail' order.pk %}" class="font-semibold text-gray-100 hover:underline">{{ order.code }}</a>
              {% with status_class=order.get_status_class %}
                <div class="mt-1">
                  <span class="text-[11px] px-1.5 py-0.5 rounded {{ status_class }} order-status" data-order-id="{{ order.pk }}">{{ order.get_status_display }}</span>
                  <form method="post" action="{% url 'orders:update_order_status' order.pk %}" class="hidden order-status-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    <select name="status" class="bg-[#161616] border border-gray-800 rounded px-2 py-1 text-xs text-gray-200" onchange="this.form.submit()">
                      {% for value,label in status_choices.items %}
                        <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </form>
                </div>
              {% endwith %}
            </div>
            <div class="mt-1">
              <p class="text-gray-400 text-sm">KH:
                {% if order.customer %}
                  <a href="{% url 'customers:customer_detail' order.customer.code %}" class="text-blue-400 hover:text-blue-300 hover:underline underline-offset-2">{{ order.customer.name }}</a>
                {% else %}
                  <span class="text-gray-300">-</span>
                {% endif %}
              </p>
              <p class="text-gray-500 text-xs">Mã KH: <span class="text-gray-400">{{ order.customer.code|default:'-' }}</span></p>
              <p class="text-gray-500 text-xs flex items-center gap-1"><i data-lucide="phone" class="w-3.5 h-3.5 text-gray-500"></i><span>{{ order.customer.phone_number|default:'-' }}</span></p>
              <p class="text-gray-400 text-sm">SP: <a href="{% url 'products:product_detail' order.product.pk %}" class="text-blue-400 hover:text-blue-300 hover:underline underline-offset-2">{{ order.product.name }}</a></p>
              <p class="text-gray-400 text-sm">NCC: <span class="text-gray-300">{{ order.product.supplier.name|default:'-' }}</span></p>
              <p class="text-gray-400 text-sm">Phân loại: <span class="text-gray-300">{{ order.color.name|default:'-' }} / {{ order.size.name|default:'-' }}</span></p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-gray-200 font-semibold">{{ order.product.price|smart_vnd }}</p>
            <p class="text-xs text-gray-500">SL: {{ order.amount }}</p>
          </div>
        </div>
        <div class="flex items-center justify-between mt-4">
          <p class="text-xs text-gray-500">{{ order.updated_at|date:"d/m/Y H:i" }}</p>
          <div class="text-right text-sm text-gray-300">
            <div>CK: {{ order.discount_safe|floatformat:0 }}đ</div>
            <div>DT: {{ order.revenue|floatformat:0 }}đ</div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-span-full bg-[#161616] border border-gray-800 rounded-lg p-6 text-center text-gray-400">Chưa có đơn hàng nào.</div>
    {% endfor %}
  </div>
{% else %}
  <!-- Table mode -->
  <div class="bg-[#121212] border border-gray-800 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-800">
        <thead class="bg-[#161616]">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider multi-only hidden">Chọn</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Mã đơn</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Khách hàng</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Sản phẩm</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Màu/Size</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Số lượng</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Đơn giá</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Chiết khấu</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Doanh thu</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Doanh thu thuần</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Trạng thái</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Ghi chú</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Thời gian cập nhật</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
          {% for order in orders %}
          <tr class="hover:bg-[#171717]">
            <td class="px-4 py-3 text-sm multi-only hidden">
              <input type="checkbox" class="order-check cursor-pointer" data-id="{{ order.id }}" style="transform: scale(1.25); transform-origin: left center;" />
            </td>
            <td class="px-4 py-3 text-sm text-blue-400">
              <a href="{% url 'orders:order_detail' order.pk %}" class="hover:underline">{{ order.code }}</a>
            </td>
            <td class="px-4 py-3 text-sm text-gray-300">
              {% if order.customer %}
                <div>
                  <a href="{% url 'customers:customer_detail' order.customer.code %}" class="text-blue-400 hover:text-blue-300 hover:underline underline-offset-2">{{ order.customer.name }}</a>
                  <div class="text-xs text-gray-500"><span class="text-gray-400">{{ order.customer.code }}</span></div>
                  <div class="text-xs text-gray-500 flex items-center gap-1"><i data-lucide="phone" class="w-3.5 h-3.5 text-gray-500"></i><span>{{ order.customer.phone_number|default:'-' }}</span></div>
                </div>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-4 py-3 text-sm text-gray-300">
              <div class="flex items-center gap-2">
                {% if order.product.image %}
                  <img src="{{ order.product.image|safe_image_url }}" alt="{{ order.product.name }}" class="w-10 h-10 object-cover rounded border border-gray-800">
                {% else %}
                  <div class="w-10 h-10 bg-[#1e1e1e] rounded border border-gray-800 flex items-center justify-center text-gray-500">
                    <i data-lucide="image" class="w-4 h-4"></i>
                  </div>
                {% endif %}
                <div>
                  <div>
                    <a href="{% url 'products:product_detail' order.product.pk %}" class="text-blue-400 hover:text-blue-300 hover:underline underline-offset-2">{{ order.product.name }}</a>
                  </div>
                  <div class="text-xs text-gray-500"><span class="text-gray-400">{{ order.product.code|default:'-' }}</span></div>
                  <div class="text-xs text-gray-500">{{ order.product.supplier.name|default:'-' }}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-300">{{ order.color.name|default:'-' }} / {{ order.size.name|default:'-' }}</td>
            <td class="px-4 py-3 text-sm text-gray-300">{{ order.amount }}</td>
            <td class="px-4 py-3 text-sm"><span class="text-blue-400 font-medium">{{ order.sale_price|smart_vnd }}</span></td>
            <td class="px-4 py-3 text-sm"><span class="text-yellow-300 font-medium">{{ order.discount_safe|smart_vnd }}</span></td>
            <td class="px-4 py-3 text-sm"><span class="text-green-400 font-medium">{{ order.revenue|smart_vnd }}</span></td>
            <td class="px-4 py-3 text-sm"><span class="text-emerald-400 font-medium">{{ order.net_profit|smart_vnd }}</span></td>
            <td class="px-4 py-3 text-sm">
              <form method="post" action="{% url 'orders:update_order_status' order.pk %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                {% with status_class=order.get_status_class %}
                  <div class="inline-flex items-center rounded border px-1.5 py-1 text-xs {{ status_class }}">
                    <select name="status" class="bg-transparent border-0 text-xs text-gray-200 focus:outline-none focus:ring-0 focus:border-0" onchange="this.form.submit()">
                      {% for value,label in status_choices.items %}
                        <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                {% endwith %}
              </form>
            </td>
            <td class="px-4 py-3 text-sm text-gray-300">{{ order.note|default:'-' }}</td>
            <td class="px-4 py-3 text-sm text-gray-400">{{ order.updated_at|date:"d/m/Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="13" class="px-4 py-6 text-center text-gray-400">
              <div class="flex flex-col items-center justify-center space-y-2">
                <i data-lucide="shopping-cart" class="w-8 h-8 text-gray-600"></i>
                <p>Chưa có đơn hàng nào</p>
                <a href="{% url 'orders:order_create' %}" class="mt-2 px-3 py-1 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-md flex items-center">
                  <i data-lucide="plus" class="w-3.5 h-3.5 mr-1"></i>
                  Tạo đơn hàng mới
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

{% endif %}

{% if is_paginated %}
<div class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-3 text-sm">
  <div class="text-gray-400">
    Trang <span class="text-gray-200 font-medium">{{ page_obj.number }}</span> / {{ page_obj.paginator.num_pages }} · Tổng <span class="text-gray-200 font-medium">{{ page_obj.paginator.count }}</span>
  </div>
  <div class="flex items-center gap-1">
    {% if page_obj.has_previous %}
      <a class="px-2 py-1 rounded border border-gray-800 bg-[#161616] text-gray-300 hover:border-gray-700" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page=1">« Đầu</a>
      <a class="px-2 py-1 rounded border border-gray-800 bg-[#161616] text-gray-300 hover:border-gray-700" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">‹ Trước</a>
    {% else %}
      <span class="px-2 py-1 rounded border border-gray-900 bg-[#111] text-gray-600">« Đầu</span>
      <span class="px-2 py-1 rounded border border-gray-900 bg-[#111] text-gray-600">‹ Trước</span>
    {% endif %}

    {% for i in page_obj.paginator.page_range %}
      {% if i >= page_obj.number|add:-2 and i <= page_obj.number|add:2 %}
        {% if page_obj.number == i %}
          <span class="px-3 py-1 rounded border border-blue-800 bg-blue-900/30 text-blue-300">{{ i }}</span>
        {% else %}
          <a class="px-3 py-1 rounded border border-gray-800 bg-[#161616] text-gray-300 hover:border-gray-700" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ i }}">{{ i }}</a>
        {% endif %}
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <a class="px-2 py-1 rounded border border-gray-800 bg-[#161616] text-gray-300 hover:border-gray-700" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">Tiếp ›</a>
      <a class="px-2 py-1 rounded border border-gray-800 bg-[#161616] text-gray-300 hover:border-gray-700" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Cuối »</a>
    {% else %}
      <span class="px-2 py-1 rounded border border-gray-900 bg-[#111] text-gray-600">Tiếp ›</span>
      <span class="px-2 py-1 rounded border border-gray-900 bg-[#111] text-gray-600">Cuối »</span>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  (function() {
    const toggleBtn = document.getElementById('btn-toggle-multi');
    const selectAllBtn = document.getElementById('btn-select-all');
    const bulkForm = document.getElementById('bulk-form');
    const bulkIds = document.getElementById('bulk-ids');
    const statusSelect = document.getElementById('bulk-status');
    function getChecks() { return document.querySelectorAll('.order-check'); }
    function getMultiOnly() { return document.querySelectorAll('.multi-only'); }
    function setMultiMode(on) {
      getMultiOnly().forEach(el => el.classList.toggle('hidden', !on));
      if (bulkForm) bulkForm.classList.toggle('hidden', !on);
    }
    function syncHiddenInputs() {
      if (!bulkIds) return;
      bulkIds.innerHTML = '';
      getChecks().forEach(cb => {
        if (cb.checked) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'order_ids';
          input.value = cb.getAttribute('data-id');
          bulkIds.appendChild(input);
        }
      });
    }
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        const anyHidden = Array.from(getMultiOnly()).some(el => el.classList.contains('hidden'));
        setMultiMode(anyHidden);
      });
    }
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        getChecks().forEach(cb => { if (!cb.checked) cb.checked = true; });
        syncHiddenInputs();
      });
    }
    document.addEventListener('change', (e) => {
      if (e.target && e.target.classList && e.target.classList.contains('order-check')) {
        syncHiddenInputs();
      }
    });
    if (bulkForm) {
      bulkForm.addEventListener('submit', (e) => {
        syncHiddenInputs();
        if (!bulkIds || bulkIds.children.length === 0) {
          e.preventDefault();
          alert('Vui lòng chọn ít nhất một đơn hàng.');
        }
      });
    }
    // initialize off
    setMultiMode(false);
  })();
  // Toggle inline status edit in card view
  document.addEventListener('click', (e) => {
    const badge = e.target.closest && e.target.closest('.order-status');
    if (badge) {
      const container = badge.parentElement;
      if (!container) return;
      const form = container.querySelector('.order-status-form');
      if (form) {
        form.classList.toggle('hidden');
      }
    }
  });
  if (window.lucide) { try { lucide.createIcons(); } catch (e) {} }
</script>
{% endblock %}
