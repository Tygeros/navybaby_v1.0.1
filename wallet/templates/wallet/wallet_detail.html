{% extends 'base.html' %}
{% load humanize %}
{% load number_extras %}

{% block title %}{{ wallet.name }} - NavyBaby{% endblock %}
{% block navbar_icon %}wallet{% endblock %}
{% block navbar_title %}Chi tiết Ví{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex justify-between items-center mb-6">
  <div>
    <h2 class="text-2xl font-bold flex items-center text-blue-400">
      <i data-lucide="wallet" class="w-6 h-6 mr-2"></i>{{ wallet.name }}
    </h2>
    <p class="text-gray-400">Quản lý giao dịch và số dư</p>
  </div>
  <div class="flex gap-2">
    <a href="{% url 'wallet:transaction_create' wallet.id %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition flex items-center gap-2">
      <i data-lucide="plus" class="w-4 h-4"></i>
      Thêm giao dịch
    </a>
    <a href="{% url 'wallet:wallet_report' wallet.id %}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md transition flex items-center gap-2">
      <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
      Báo cáo
    </a>
    <a href="{% url 'wallet:wallet_edit' wallet.id %}" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition flex items-center gap-2">
      <i data-lucide="edit" class="w-4 h-4"></i>
      Chỉnh sửa
    </a>
    <a href="{% url 'wallet:wallet_list' %}" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition flex items-center gap-2">
      <i data-lucide="arrow-left" class="w-4 h-4"></i>
      Quay lại
    </a>
  </div>
</div>

<!-- Thống kê -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-gradient-to-r from-emerald-900/30 to-green-900/30 border border-emerald-800 rounded-lg p-5">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm mb-1">Số dư hiện tại</p>
        {% if wallet.currency == 'VND' %}
        <h3 class="text-2xl font-bold text-emerald-400">{{ wallet.balance|smart_vnd }}</h3>
        {% else %}
        <h3 class="text-2xl font-bold text-emerald-400">{{ wallet.balance|floatformat:2 }} {{ wallet.currency }}</h3>
        {% endif %}
      </div>
      <i data-lucide="wallet" class="w-10 h-10 text-emerald-400"></i>
    </div>
  </div>
  
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-5">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm mb-1">Tổng nạp tiền</p>
        {% if wallet.currency == 'VND' %}
        <h3 class="text-2xl font-bold text-blue-400">{{ total_deposits|smart_vnd }}</h3>
        {% else %}
        <h3 class="text-2xl font-bold text-blue-400">{{ total_deposits|floatformat:2 }} {{ wallet.currency }}</h3>
        {% endif %}
      </div>
      <i data-lucide="arrow-down-circle" class="w-10 h-10 text-blue-400"></i>
    </div>
  </div>
  
  <div class="bg-[#161616] border border-gray-800 rounded-lg p-5">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm mb-1">Tổng chi tiêu</p>
        {% if wallet.currency == 'VND' %}
        <h3 class="text-2xl font-bold text-orange-400">{{ total_withdrawals|smart_vnd }}</h3>
        {% else %}
        <h3 class="text-2xl font-bold text-orange-400">{{ total_withdrawals|floatformat:2 }} {{ wallet.currency }}</h3>
        {% endif %}
      </div>
      <i data-lucide="arrow-up-circle" class="w-10 h-10 text-orange-400"></i>
    </div>
  </div>
</div>

<!-- Bộ lọc -->
<div class="bg-[#161616] border border-gray-800 rounded-lg p-4 mb-6">
  <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">Từ ngày</label>
      <input type="date" name="start_date" value="{{ start_date }}" class="w-full bg-[#0a0a0a] border border-gray-700 rounded-md px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">Đến ngày</label>
      <input type="date" name="end_date" value="{{ end_date }}" class="w-full bg-[#0a0a0a] border border-gray-700 rounded-md px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">Loại giao dịch</label>
      <select name="transaction_type" class="w-full bg-[#0a0a0a] border border-gray-700 rounded-md px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
        <option value="">Tất cả</option>
        {% for value, label in transaction_types %}
        <option value="{{ value }}" {% if transaction_type == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">Danh mục</label>
      <select name="category" class="w-full bg-[#0a0a0a] border border-gray-700 rounded-md px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
        <option value="">Tất cả</option>
        {% for value, label in categories %}
        <option value="{{ value }}" {% if category == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex items-end gap-2">
      <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition">
        <i data-lucide="filter" class="w-4 h-4 inline mr-1"></i>Lọc
      </button>
      <a href="{% url 'wallet:wallet_detail' wallet.id %}" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition">
        <i data-lucide="x" class="w-4 h-4"></i>
      </a>
    </div>
  </form>
</div>

<!-- Danh sách giao dịch -->
<div class="bg-[#121212] border border-gray-800 rounded-lg overflow-hidden">
  <div class="p-4 border-b border-gray-800">
    <h3 class="text-lg font-semibold text-gray-100 flex items-center">
      <i data-lucide="list" class="w-5 h-5 mr-2"></i>Lịch sử giao dịch
    </h3>
  </div>
  
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-[#0a0a0a] border-b border-gray-800">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Ngày</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Loại</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Danh mục</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Số tiền</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Mô tả</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Mã tham chiếu</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase">Thao tác</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-800">
        {% for transaction in transactions %}
        <tr class="hover:bg-[#161616] transition">
          <td class="px-4 py-3 text-sm text-gray-300">{{ transaction.transaction_date|date:"d/m/Y H:i" }}</td>
          <td class="px-4 py-3 text-sm">
            {% if transaction.transaction_type == 'deposit' %}
            <span class="px-2 py-1 text-xs rounded bg-blue-900/30 text-blue-400 border border-blue-800">
              <i data-lucide="arrow-down-circle" class="w-3 h-3 inline"></i> Nạp tiền
            </span>
            {% else %}
            <span class="px-2 py-1 text-xs rounded bg-orange-900/30 text-orange-400 border border-orange-800">
              <i data-lucide="arrow-up-circle" class="w-3 h-3 inline"></i> Chi tiêu
            </span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-sm text-gray-300">{{ transaction.get_category_display }}</td>
          <td class="px-4 py-3 text-sm font-semibold {% if transaction.transaction_type == 'deposit' %}text-emerald-400{% else %}text-orange-400{% endif %}">
            {% if wallet.currency == 'VND' %}
              {% if transaction.transaction_type == 'deposit' %}+{% else %}-{% endif %}{{ transaction.amount|smart_vnd }}
            {% else %}
              {% if transaction.transaction_type == 'deposit' %}+{% else %}-{% endif %}{{ transaction.amount|floatformat:2 }} {{ wallet.currency }}
            {% endif %}
          </td>
          <td class="px-4 py-3 text-sm text-gray-400">{{ transaction.description|truncatewords:10|default:"-" }}</td>
          <td class="px-4 py-3 text-sm">
            {% if transaction.reference_code %}
              {% if transaction.reference_code|slice:":6" == "TRANS-" %}
                {% with finance_id=transaction.reference_code|slice:"6:" %}
                <a href="{% url 'finance:transaction_update' finance_id %}" class="text-blue-400 hover:text-blue-300 underline transition flex items-center gap-1" title="Xem giao dịch tài chính gốc">
                  <i data-lucide="external-link" class="w-3 h-3"></i>
                  {{ transaction.reference_code }}
                </a>
                {% endwith %}
              {% else %}
                <span class="text-gray-400">{{ transaction.reference_code }}</span>
              {% endif %}
            {% else %}
              <span class="text-gray-500">-</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-center">
            <div class="flex justify-center gap-2">
              <a href="{% url 'wallet:transaction_edit' transaction.id %}" class="text-blue-400 hover:text-blue-300 transition">
                <i data-lucide="edit" class="w-4 h-4"></i>
              </a>
              <a href="{% url 'wallet:transaction_delete' transaction.id %}" class="text-red-400 hover:text-red-300 transition">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="px-4 py-8 text-center text-gray-400">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-600"></i>
            <p>Chưa có giao dịch nào</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  lucide.createIcons();
</script>
{% endblock %}
